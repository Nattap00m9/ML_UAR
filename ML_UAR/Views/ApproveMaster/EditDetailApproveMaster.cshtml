@{
    ViewData["Title"] = "แก้ไขข้อมูลสายการอนุมัติ";

    ViewData["Breadcrumb"] = new List<BreadcrumbModel> {
        new BreadcrumbModel { Text = "ตั้งค่าสายการอนุมัติ", Link = "/ApproveMaster/TransactionApproveMaster" },
        new BreadcrumbModel { Text = "แก้ไขข้อมูลสายการอนุมัติ" }
    };
}

<form id="submit_form" method="post" enctype="multipart/form-data">
    <div class="card">
        <div class="card-header">
            <b>แก้ไขสายการอนุมัติ</b>
        </div>

        <div class="card-body">
            <div class="row">
                <label for="txtApproveName" class="col-sm-3 col-form-label text-right">
                    ชื่อสายการอนุมัติ : <span style="color:#ff0000;">*</span>
                </label>
                <div class="col-sm-6">
                    <div class="form-group">
                        <input type="text" name="txtApproveName" id="txtApproveName" class="form-control" autocomplete="off" value="@ViewBag.approve_master_name" />
                        <input type="hidden" class="form-control" id="txtApproveMasterID" name="txtApproveMasterID" value="@ViewBag.approve_master_id" readonly />
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group col-form-label clearfix">
                        <div class="icheck-success d-inline">
                            <input type="radio" name="raiApproveMasterStatus" id="raiApproveMasterEnable" value="E" @ViewBag.status_enable>
                            <label for="raiApproveMasterEnable">
                                ใช้งาน
                            </label>
                        </div>
                        <div class="icheck-danger d-inline">
                            <input type="radio" name="raiApproveMasterStatus" id="raiApproveMasterDisable" value="D" @ViewBag.status_disable>
                            <label for="raiApproveMasterDisable">
                                ไม่ใช้งาน
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-2">
                <div class="col-sm-12 float-lg-right">
                    <div class="btn-group float-lg-right">
                        <button type="button" class="btn-defaul btn btn-outline-primary" id="btnAddApproveFlow" onclick="onAddApproveFlow()">
                            <i class="fas fa-user-plus"></i> เพิ่มผู้ดำเนินการ/ผู้อนุมัติ
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <table id="tblApproveMaster" class="table table-striped table-hover table-bordered" width="100%">
                        <thead>
                            <tr>
                                <th width="10%">ลำดับการอนุมัติ</th>
                                <th width="10%">รหัสพนักงาน</th>
                                <th width="15%">ชื่อ-นามสกุล</th>
                                <th width="15%">E-mail</th>
                                <th width="15%">ประเภทการอนุมัติ</th>
                                <th width="15%">Backup E-mail</th>
                                <th width="3%">สถานะ</th>
                                <th width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>

        <div class="card-footer">
            <div class="row">
                <div class="col-6">
                    <div style="text-align:left;">
                        <a href="/ApproveMaster/TransactionApproveMaster" class="btn btn-outline-dark" id="btnBack">
                            <i class="fas fa-arrow-circle-left"></i> ย้อนกลับ
                        </a>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-right">

                        <button type="button" class="btn btn-outline-danger mr-3" id="btnReset" onclick="onResetClick()">
                            <i class="fas fa-redo-alt"></i> รีเซ็ต
                        </button>

                        <button type="submit" class="btn btn-outline-success mr-3" id="btnSubmit" name="btnSubmit">
                            <i class="fas fa-save"></i> บันทึก
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @*
    modal add approve flow
    *@
    <div class="modal fade" id="modalAddApproveFlow" role="dialog" tabindex="-1" aria-labelledby="modalAddApproveFlow" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-center ">
                    <h4 class="modal-title"> เพิ่มผู้ดำเนินการ/ผู้อนุมัติ </h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body modal-body-single">

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="txtmodalApproveLevel">ลำดับดำเนินการ <span style="color:#ff0000;">*</span></label>
                                <input type="text" class="form-control" id="txtmodalApproveLevel" name="txtmodalApproveLevel" autocomplete="off" />
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="ddlmodalPersonnelList">รหัสพนักงาน <span style="color:#ff0000;">*</span></label>
                                @Html.DropDownList("ddlmodalPersonnelList",
                                new SelectList(ViewBag.PersonnelList, "Value", "Text"),
                                new
                                {
                                @class = "form-control select2bs4 select-placeholder",
                                style = "width: 100%"
                                }
                                )
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="ddlmodalApproveTypeList">ประเภท <span style="color:#ff0000;">*</span></label>
                                @Html.DropDownList("ddlmodalApproveTypeList",
                                new SelectList(ViewBag.ApproveTypeList, "Value", "Text"),
                                new
                                {
                                @class = "form-control select2bs4 select-placeholder",
                                style = "width: 100%"
                                }
                                )
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="txtmodalBackUpEmail">กรณีเร่งรีบ(ถ้ามี)</label>
                                <input type="text" class="form-control" id="txtmodalBackUpEmail" name="txtmodalBackUpEmail" autocomplete="off" />
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group clearfix">
                                <div class="icheck-primary d-inline">
                                    <input type="checkbox" id="chbmodalisFinalApprove" name="chbmodalisFinalApprove">
                                    <label for="chbmodalisFinalApprove">
                                        ลำดับสุดท้าย
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group clearfix">
                                <div class="icheck-success d-inline">
                                    <input type="radio" name="raimodalStatus" checked="" id="raimodalEnable" value="E">
                                    <label for="raimodalEnable">
                                        ใช้งาน
                                    </label>
                                </div>
                                <div class="icheck-danger d-inline">
                                    <input type="radio" name="raimodalStatus" id="raimodalDisable" value="D">
                                    <label for="raimodalDisable">
                                        ไม่ใช้งาน
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer float-lg-right">
                    <button type="submit" class="btn btn-outline-success mr-3" id="btnAddFlowonTbl" name="btnAddFlowonTbl">
                        <i class="fas fa-plus-circle"></i> ยืนยัน
                    </button>
                    <button type="button" class="btn btn-outline-danger mr-3" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times-circle"></i> ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>

    @*modal confirm main save*@
    <div class="modal fade" id="modalConfirmSave" style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <b class="modal-title">ยืนยันการบันทึกข้อมูล</b>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <h4>ต้องการบันทึกข้อมูลใช่หรือไม่ ?</h4>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-danger" data-dismiss="modal">
                        <i class="fas fa-ban"></i> ยกเลิก
                    </button>
                    <button type="button" id="btnConfirmSave" onclick="onSubmitForm()" class="btn btn-outline-success">
                        <i class="fas fa-check-circle"></i> ดำเนินการ
                    </button>
                </div>
            </div>

        </div>
    </div>

    @*
    modal edit approve flow
    *@
    <div class="modal fade" id="modalEditApproveFlow" role="dialog" tabindex="-1" aria-labelledby="modalEditApproveFlow" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-center ">
                    <h4 class="modal-title"> แก้ไขผู้ดำเนินการ/ผู้อนุมัติ </h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body modal-body-single">

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="txtmodalApproveLevel_edit">ลำดับดำเนินการ <span style="color:#ff0000;">*</span></label>
                                <input type="text" class="form-control" id="txtmodalApproveLevel_edit" name="txtmodalApproveLevel_edit" autocomplete="off" />
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="ddlmodalPersonnelList_edit">รหัสพนักงาน <span style="color:#ff0000;">*</span></label>
                                @Html.DropDownList("ddlmodalPersonnelList_edit",
                                new SelectList(ViewBag.PersonnelList, "Value", "Text"),
                                new
                                {
                                @class = "form-control select2bs4",
                                style = "width: 100%"
                                }
                                )
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="ddlmodalApproveTypeList_edit">ประเภท <span style="color:#ff0000;">*</span></label>
                                @Html.DropDownList("ddlmodalApproveTypeList_edit",
                                new SelectList(ViewBag.ApproveTypeList, "Value", "Text"),
                                new
                                {
                                @class = "form-control select2bs4",
                                style = "width: 100%"
                                }
                                )
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="txtmodalBackUpEmail_edit">กรณีเร่งรีบ(ถ้ามี)</label>
                                <input type="text" class="form-control" id="txtmodalBackUpEmail_edit" name="txtmodalBackUpEmail_edit" autocomplete="off" />
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group clearfix">
                                <div class="icheck-primary d-inline">
                                    <input type="checkbox" id="chbmodalisFinalApproveOld" name="chbmodalisFinalApprove">
                                    <label for="chbmodalisFinalApproveOld">
                                        ลำดับสุดท้าย
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group clearfix">
                                <div class="icheck-success d-inline">
                                    <input type="radio" name="raiStatus_edit" id="raimodalEnableOld">
                                    <label for="raimodalEnableOld">
                                        ใช้งาน
                                    </label>
                                </div>
                                <div class="icheck-danger d-inline">
                                    <input type="radio" name="raiStatus_edit" id="raimodalDisableOld">
                                    <label for="raimodalDisableOld">
                                        ไม่ใช้งาน
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer float-lg-right">
                    <input type="hidden" id="apvFlowId_mdl" />
                    <button type="submit" class="btn btn-outline-success mr-3" id="btnEditFlowonTbl" name="btnEditFlowonTbl">
                        <i class="fas fa-plus-circle"></i> ยืนยัน
                    </button>
                    <button type="button" class="btn btn-outline-danger mr-3" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times-circle"></i> ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>

    @*modal reason delete*@
    <div class="modal fade" id="modalReasonDel" style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <b class="modal-title">ยืนยันการลบข้อมูล</b>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">

                    @*<h4>ต้องการลบข้อมูลใช่หรือไม่ ?</h4>*@
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="ddlmodalReasonList">เหตุผลในการลบ <span style="color:#ff0000;">*</span></label>
                                @Html.DropDownList("ddlmodalReasonList",
                                new SelectList(ViewBag.ReasonDelList, "Value", "Text"),
                                new
                                {
                                @class = "form-control select2bs4 select-placeholder",
                                style = "width: 100%"
                                }
                                )
                            </div>
                        </div>
                    </div>

                    <div class="row" id="remarkForm">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="exampleFormControlTextarea1">รายละเอียดเพิ่มเติม</label>
                                <textarea class="form-control" id="txtRemark" rows="3"></textarea>
                            </div>
                        </div>
                    </div>


                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-danger" data-dismiss="modal">
                        <i class="fas fa-ban"></i> ยกเลิก
                    </button>
                    <button type="submit" id="btnReasonDel" class="btn btn-outline-success">
                        <i class="fas fa-check-circle"></i> ดำเนินการ
                    </button>
                    <input type="hidden" id="delApproveFlowId" />
                </div>
            </div>

        </div>
    </div>

</form>

@section scripts {
    <script>
        $(document).ready(function () {
            fetchApproveFlow();
            setValueEdit();
            //filter
            //filter_ddlPerson();

            //$.validator.addMethod('select2Required', function (value, element) {
            //    return value && value.trim() !== '';
            //});

            // trigger id btn for submitHandler
            $('button[type="submit"]').on('click', function () {
                $('#submit_form').data('submittedBy', this.id);
            });

            //initialize validate form
            $('#submit_form').validate({
                messages: {
                    txtApproveName: {
                        required: "กรุณากรอกชื่อสายการอนุมัติ"
                    },
                    txtmodalApproveLevel: {
                        required: "กรุณากรอกลำดับการดำเนินการ",
                        digits: "กรุณากรอกเฉพาะตัวเลข"
                    },
                    txtmodalApproveLevel_edit: {
                        required: "กรุณากรอกลำดับการดำเนินการ",
                        digits: "กรุณากรอกเฉพาะตัวเลข"
                    },
                    ddlmodalPersonnelList: {
                        required: "กรุณาเลือกพนักงาน"
                    },
                    ddlmodalApproveTypeList: {
                        required: "กรุณาเลือกประเภท"
                    },
                    ddlmodalPersonnelList_edit: {
                        required: "กรุณาเลือกพนักงาน"
                    },
                    ddlmodalApproveTypeList_edit: {
                        required: "กรุณาเลือกประเภท"
                    },
                    ddlmodalReasonList: {
                        required: "กรุณาเลือกเหตุผลในการลบ"
                    }
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                },
                submitHandler: function (form) {
                    var submitButtonId = $(form).data('submittedBy');

                    if (submitButtonId === 'btnSubmit') {
                        $("#modalConfirmSave").modal("show");
                    }
                    else if (submitButtonId === 'btnAddFlowonTbl') {
                        $("#modalAddApproveFlow").modal("hide");
                        onAddFlowonTbl();
                    }
                    else if (submitButtonId === 'btnEditFlowonTbl') {
                        onSubmitEditFlow();
                    }
                    else if (submitButtonId === 'btnReasonDel') {
                        onDeleteFlow();
                    }
                }
            });

            //approve name
            $("#btnSubmit").on("click", function () {

                $("#txtApproveName").rules('add', {
                    required: true
                });

                $("#txtmodalApproveLevel").rules('remove');
                $("#txtmodalApproveLevel_edit").rules('remove');
                $("#ddlmodalPersonnelList").rules('remove');
                $("#ddlmodalApproveTypeList").rules('remove');
                $("#ddlmodalPersonnelList_edit").rules('remove');
                $("#ddlmodalApproveTypeList_edit").rules('remove');
                $("#ddlmodalReasonList").rules('remove');

                $('#submit_form').valid();

            })

            //add approve flow
            $("#btnAddFlowonTbl").on("click", function () {

                $("#txtmodalApproveLevel").rules('add', {
                    required: true,
                    digits: true
                });
                $("#ddlmodalPersonnelList").rules('add', {
                    required: true
                });
                $("#ddlmodalApproveTypeList").rules('add', {
                    required: true
                });

                $("#txtApproveName").rules('remove');
                $("#txtmodalApproveLevel_edit").rules('remove');
                $("#ddlmodalPersonnelList_edit").rules('remove');
                $("#ddlmodalApproveTypeList_edit").rules('remove');
                $("#ddlmodalReasonList").rules('remove');

                $('#submit_form').valid();
            })

            // edit approve flow
            $("#btnEditFlowonTbl").on("click", function () {

                $("#txtmodalApproveLevel_edit").rules('add', {
                    required: true,
                    digits: true
                });
                $("#ddlmodalPersonnelList_edit").rules('add', {
                    required: true
                });
                $("#ddlmodalApproveTypeList_edit").rules('add', {
                    required: true
                });

                $("#txtApproveName").rules('remove');
                $("#txtmodalApproveLevel").rules('remove');
                $("#ddlmodalPersonnelList").rules('remove');
                $("#ddlmodalApproveTypeList").rules('remove');
                $("#ddlmodalReasonList").rules('remove');

                $('#submit_form').valid();
            })

            //delete approve flow
            $("#btnReasonDel").on("click",function(){
                $("#ddlmodalReasonList").rules('add', {
                    required: true
                });

                $("#txtmodalApproveLevel").rules('remove');
                $("#txtmodalApproveLevel_edit").rules('remove');
                $("#ddlmodalPersonnelList").rules('remove');
                $("#ddlmodalApproveTypeList").rules('remove');
                $("#ddlmodalPersonnelList_edit").rules('remove');
                $("#ddlmodalApproveTypeList_edit").rules('remove');
                $("#txtApproveName").rules('remove');

                $('#submit_form').valid();
            })
        });

        function fetchApproveFlow() {
            $("#tblApproveMaster").DataTable({
                "paging": true,
                "lengthChange": false,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                "bDestroy": true,
                "scrollX": false,
                ajax: {
                    url: "/ApproveMaster/GetApproveFlowTrans",
                    type: "post",
                    data: { approve_master_id: @ViewBag.approve_master_id },
                    headers: {
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    },
                    async: true
                },
                columns: [
                    { data: "approve_level" },
                    { data: "personnel_code" },
                    { data: "thname" },
                    { data: "e_mail" },
                    { data: "aprvtype_name_th" },
                    { data: "backup_email" },
                    { data: "status" },
                    { data: null },
                    { data: "approve_flow_id" },
                ],
                columnDefs: [
                    {
                        targets: 6,
                        render: function (data, type, row) {
                            if (data == "E") {
                                return span_datatable("success", "fas fa-check", "ใช้งาน");
                            }
                            else {
                                return span_datatable("danger", "fas fa-times", "ไม่ใช้งาน");
                            }
                        }
                    },
                    {
                        targets: 7,
                        render: function (data, type, row) {
                            let id = row.approve_flow_id;

                            var link = '';
                            link += '<div class="margin">';
                            link += '<button type="button" class="btn btn-sm mr-3 btn-outline-warning" id="btnEditOld' + id + '" onclick="onEditClick(' + id + ')"><i class="fas fa-edit"></i> แก้ไขข้อมูล</button>';
                            link += '<button type="button" class="btn btn-sm mr-3 btn-outline-danger" id="btnDeleteOld' + id + '" onclick="onDeleteClick(' + id + ')"><i class="fas fa-trash"></i> ลบข้อมูล</button>';
                            link += '<input type="hidden" id="txtApproveLevelOld' + id + '" name="txtApproveLevel" value="' + row.approve_level + '" ></input>';
                            link += '<input type="hidden" id="txtPersonnelCodeOld' + id + '" name="txtPersonnelCode" value="' + row.personnel_code + '" ></input>';
                            link += '<input type="hidden" id="txtPersonnelNameOld' + id + '" value="' + row.thname + '"></input>';
                            link += '<input type="hidden" id="txtEmailOld' + id + '" name="txtEmail" value="' + row.e_mail + '"></input>';
                            link += '<input type="hidden" id="txtApproveTypeOld' + id + '" value="' + row.approve_type_txt + '"></input>';
                            link += '<input type="hidden" id="txtBackUPEmailOld' + id + '" name="txtBackUPEmail" value="' + row.backup_email + '"></input>';
                            link += '<input type="hidden" id="txtStatusOld' + id + '" name="txtStatus" value="' + row.status + '"></input>';
                            link += '<input type="hidden" id="txtApproveTypeIDOld' + id + '" name="txtApproveTypeID" value="' + row.approve_type + '"></input>';
                            link += '<input type="hidden" id="txtisFinalOld' + id + '" name="txtisFinal" value="' + row.isFinal + '"></input>';
                            link += '<input type="hidden" id="txtApproveFlowID' + id + '" name="txtApproveFlowID" value="' + id + '"></input>';
                            link += '<input type="hidden" id="txtisNewFlowOld' + id + '" name="txtisNewFlow" value="0"></input>';
                            link += '<input type="hidden" id="txtisDeleteOld' + id + '" name="txtisDelete" value="0"></input>';

                            // reasoncode
                            link += '<input type="hidden" id="txtReasonCode' + id + '" name="txtReasonCode"></input>';
                            link += '<input type="hidden" id="txtRemark' + id + '" name="txtRemark"></input>';

                            link += '</div>';
                            return link;

                        }
                    },
                    { "visible": false, "targets": 8 }
                ],
            });
        }

        //btn add new approveflow
        function onAddApproveFlow() {
            $('#submit_form').find('.is-invalid').removeClass('is-invalid');
            $("#modalAddApproveFlow").modal("show");

            $("#txtmodalApproveLevel").val("");
            $("#ddlmodalPersonnelList").val("");
            $("#ddlmodalApproveTypeList").val("");

            $('#ddlmodalPersonnelList').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modalAddApproveFlow')
            }).trigger('change');

            $('#ddlmodalApproveTypeList').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modalAddApproveFlow')
            }).trigger('change');

            $("#txtmodalBackUpEmail").val("");

            document.getElementById('raimodalEnable').checked = true;
            document.getElementById('raimodalDisable').checked = false;

            document.getElementById('chbmodalisFinalApprove').checked = false;
        }

        //fetch data in modal
        function onEditClick(approve_flow_id) {
            $('#submit_form').find('.is-invalid').removeClass('is-invalid');
            $("#modalEditApproveFlow").modal("show");

            $('#ddlmodalPersonnelList_edit').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modalEditApproveFlow')
            }).trigger('change');

            $('#ddlmodalApproveTypeList_edit').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modalEditApproveFlow')
            }).trigger('change');

            $.ajax({
                url: "/ApproveMaster/GetApproveFlowById",
                type: "get",
                data: { approve_master_id: @ViewBag.approve_master_id, approve_flow_id: approve_flow_id },
            }).done(function (data) {
                if (data != false) {

                    $('input[name="txtmodalApproveLevel_edit"]').val(data.approve_level);
                    $('input[name="txtmodalBackUpEmail_edit"]').val(data.backup_email);

                    var ddlPerson = $('option[value="' + data.personnel_code + '"]');
                    ddlPerson.prop('selected', true);
                    ddlPerson.trigger('change');


                    var ddlApvType = $('option[value="' + data.approve_type + '"]');
                    ddlApvType.prop('selected', true);
                    ddlApvType.trigger('change');

                    //checked checkbox
                    if (data.isFinal == "1") {
                        $("#chbmodalisFinalApproveOld").prop("checked", true);
                        $("#chbmodalisFinalApproveOld").val("1");
                    } else {
                        $("#chbmodalisFinalApproveOld").prop("checked", false);
                        $("#chbmodalisFinalApproveOld").val("0");
                    }

                    //checked radio
                    if (data.status == "E") {
                        $("#raimodalEnableOld").prop("checked", true);
                        $('input[name="raiStatus_edit"]').val("E");
                        $("#raimodalDisableOld").prop("checked", false);
                    } else {
                        $("#raimodalDisableOld").prop("checked", true);
                        $('input[name="raiStatus_edit"]').val("D");
                        $("#raimodalEnableOld").prop("checked", false);
                    }

                    $("#apvFlowId_mdl").val(approve_flow_id);
                }
            });
        }

        //btn delete in tbl
        function onDeleteClick(approve_flow_id) {
            $('#submit_form').find('.is-invalid').removeClass('is-invalid');
            $("#modalReasonDel").modal('show');

            $("#delApproveFlowId").val(approve_flow_id);

            $("#ddlmodalReasonList").val("");

            $("#remarkForm").hide();

            $('#ddlmodalReasonList').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modalReasonDel')
            }).trigger('change');


            $("#ddlmodalReasonList").on("change", function () {
                console.log("ok");
                if ($(this).val() == "DEL-01") {
                    $("#remarkForm").show();
                }
            })
        }

        //replace value for edit
        function setValueEdit() {
            var table = $("#tblApproveMaster").DataTable();
            let id = $("#apvFlowId_mdl").val();

            let chb = $("#chbmodalisFinalApproveOld");
            chb.on("change", function () {
                if ($(this).is(':checked')) {
                    $(this).val("1");
                } else {
                    $(this).val("0");
                }
            });

            let rdoEnable = $("#raimodalEnableOld");
            let rdoDisable = $("#raimodalDisableOld");

            rdoEnable.on("change", function () {
                if ($(this).is(":checked")) {
                    $('input[name="raiStatus_edit"]').val("E");
                }
                //else {
                //    var oldValue = $('#txtStatusOld' + id).val();
                //    $('input[name="raiStatus_edit"]').val(oldValue);
                //}

            });

            rdoDisable.on("change", function () {
                if ($(this).is(":checked")) {
                    $('input[name="raiStatus_edit"]').val("D");
                }
                //else {
                //    var oldValue = $('#txtStatusOld' + id).val();
                //    $('input[name="raiStatus_edit"]').val(oldValue);

                //}
            });

        }

        //submit save form redirect
        function onSubmitForm() {
            var table = $("#tblApproveMaster").DataTable();
            var values = $('#submit_form').serialize();

            $.ajax({
                url: "/ApproveMaster/FormAddNewApproveFlow",
                type: "post",
                data: values,
            }).done(function (data) {

                if (data.code == "200") {
                    $("#modalConfirmSave").modal("hide");
                    fnAlertSuccess(data.message, "/ApproveMaster/TransactionApproveMaster");

                }
                else {
                    $("#modalConfirmSave").modal("hide");
                    fnAlertError(data.message);
                }
            });
        }

        function onSubmitEditFlow() {
            var table = $("#tblApproveMaster").DataTable();
            var id = $("#apvFlowId_mdl").val();

            var mdl1 = $('input[name="txtmodalApproveLevel_edit"]').val();
            var mdl2 = $("#ddlmodalPersonnelList_edit").val();
            var mdl3 = $("#ddlmodalApproveTypeList_edit").val();
            var mdl4 = $('input[name="txtmodalBackUpEmail_edit"]').val();
            var mdl5 = $("#chbmodalisFinalApproveOld").val();
            var mdl6 = $('input[name="raiStatus_edit"]').val();

            var oldStatus = $("#txtStatusOld" + id).val();

            //replace data when edit
            $("#txtApproveLevelOld" + id).val(mdl1);
            $("#txtPersonnelCodeOld" + id).val(mdl2);
            $("#txtApproveTypeIDOld" + id).val(mdl3);
            $("#txtBackUPEmailOld" + id).val(mdl4);
            $("#txtisFinalOld" + id).val(mdl5);
            //if(){

            //}
            $("#txtStatusOld" + id).val(mdl6);

            var dataEdit = {
                txtApproveFlowID: $("#txtApproveFlowID" + id).val(),
                txtisDelete: $("#txtisDeleteOld" + id).val(),
                txtApproveLevel: $("#txtApproveLevelOld" + id).val(),
                txtPersonnelCode: $("#txtPersonnelCodeOld" + id).val(),
                txtApproveTypeID: $("#txtApproveTypeIDOld" + id).val(),
                txtBackUPEmail: $("#txtBackUPEmailOld" + id).val(),
                txtStatus: $("#txtStatusOld" + id).val(),
                txtReasonCode: $("#txtReasonCode" + id).val(),
                txtRemark: $("#txtRemark" + id).val(),
                txtisFinal: $("#txtisFinalOld" + id).val(),
                txtisNewFlow: $("#txtisNewFlowOld" + id).val()
            }

            $.ajax({
                url: "/ApproveMaster/FormEditApproveFlow",
                type: "post",
                data: dataEdit,
            }).done(function (data) {
                if (data.code == "200") {
                    $("#modalEditApproveFlow").modal('hide');
                    fnAlertSuccess(data.message);
                    //table.ajax.reload();
                }
                else {
                    $("#modalEditApproveFlow").modal("hide");
                    fnAlertError(data.message);
                }
            });
        }

        //submit delete redirect page
        function onDeleteFlow() {
            var table = $("#tblApproveMaster").DataTable();

            var id = $("#delApproveFlowId").val();
            var reason_c = $("#ddlmodalReasonList").val();
            var remark = $("#txtRemark").val();

            $("#txtisDeleteOld" + id).val("1");
            $("#txtReasonCode" + id).val(reason_c);
            $("#txtRemark" + id).val(remark);

            //var values = $('#submit_form').serialize();

            var dataDelete = {
                txtApproveFlowID: $("#txtApproveFlowID" + id).val(),
                txtisDelete: $("#txtisDeleteOld" + id).val(),
                txtApproveLevel: $("#txtApproveLevelOld" + id).val(),
                txtPersonnelCode: $("#txtPersonnelCodeOld" + id).val(),
                txtApproveTypeID: $("#txtApproveTypeIDOld" + id).val(),
                txtBackUPEmail: $("#txtBackUPEmailOld" + id).val(),
                txtStatus: $("#txtStatusOld" + id).val(),
                txtReasonCode: $("#txtReasonCode" + id).val(),
                txtRemark: $("#txtRemark" + id).val(),
                txtisFinal: $("#txtisFinalOld" + id).val(),
                txtisNewFlow: $("#txtisNewFlowOld" + id).val()ส
            }

            $.ajax({
                url: "/ApproveMaster/FormEditApproveFlow",
                type: "post",
                data: dataDelete,
            }).done(function (data) {

                if (data.code == "200") {
                    //table.ajax.reload();
                    $("#modalReasonDel").modal("hide");
                    fnAlertSuccess(data.message);
                }
                else {
                    $("#modalReasonDel").modal("hide");
                    fnAlertError(data.message);
                }

            });

        }

        //add new preview
        var counter = 1;

        function onAddFlowonTbl() {

            var approve_level = $("#txtmodalApproveLevel").val();
            var personnel_code = $("#ddlmodalPersonnelList").val();
            var approve_type = $("#ddlmodalApproveTypeList").val();

            //if (approve_level == "" ||
            //    personnel_code == "" || personnel_code == null ||
            //    approve_type == "" || approve_type == null) {
            //    alert("กรุณาใส่ข้อมูลให้ครบ");
            //    return false;
            //}

            var approve_type_txt = $("#ddlmodalApproveTypeList option:selected").text();
            var backup_email = $("#txtmodalBackUpEmail").val();
            var status = $('input[name="raimodalStatus"]:checked').val();
            var ststusdesc = "";
            if (status == "E") {
                ststusdesc = span_datatable("success", "fas fa-check", "ใช้งาน");
            } else {
                ststusdesc = span_datatable("danger", "fas fa-times", "ไม่ใช้งาน");
            }
            var isfinal = $('#chbmodalisFinalApprove').is(":checked") ? 1 : 0;

            $.ajax({
                url: "/Settings/getPersonnelDetail?personnel_code=" + personnel_code,
                type: "get"
            }).done(function (data) {

                if (data != false) {

                    $('<tr id="tbrow' + counter + '">' +
                        '<td>' +
                        approve_level +
                        '</td>' +
                        '<td>' +
                        personnel_code +
                        '</td>' +
                        '<td>' +
                        data.thname +
                        '</td>' +
                        '<td>' +
                        data.e_mail +
                        '</td>' +
                        '<td>' +
                        approve_type_txt +
                        '</td>' +
                        '<td>' +
                        backup_email +
                        '</td>' +
                        '<td>' +
                        ststusdesc +
                        '</td>' +
                        '<td>' +
                        '<button type="button" class="btn btn-sm mr-3 btn-outline-danger" onclick="onDeleteTr(' + counter + ')"><i class="fas fa-trash"></i> ลบข้อมูล</button>' +

                        '<input type="hidden" id="txtApproveLevel' + counter + '" name="txtApproveLevel" value="' + approve_level + '" ></input>' +
                        '<input type="hidden" id="txtPersonnelCode' + counter + '" name="txtPersonnelCode" value="' + personnel_code + '" ></input>' +
                        '<input type="hidden" id="txtPersonnelName' + counter + '" value="' + data.thname + '"></input>' +
                        '<input type="hidden" id="txtEmail' + counter + '" name="txtEmail" value="' + data.e_mail + '"></input>' +
                        '<input type="hidden" id="txtApproveType' + counter + '" value="' + approve_type_txt + '"></input>' +
                        '<input type="hidden" id="txtBackUPEmail' + counter + '" name="txtBackUPEmail" value="' + backup_email + '"></input>' +
                        '<input type="hidden" id="txtStatus' + counter + '" name="txtStatus" value="' + status + '"></input>' +
                        '<input type="hidden" id="txtApproveTypeID' + counter + '" name="txtApproveTypeID" value="' + approve_type + '"></input>' +
                        '<input type="hidden" id="txtisFinal' + counter + '" name="txtisFinal" value="' + isfinal + '"></input>' +
                        '<input type="hidden" id="txtisNewFlow' + counter + '" name="txtisNewFlow" value="1"></input>' +

                        '</td>' +
                        '</tr>').appendTo('#tblApproveMaster');

                    counter++;
                }
            });


        }

        function onDeleteTr(counter) {
            $('#tbrow' + counter).remove();
            return false;
        }

        function onResetClick() {
            location.reload();

        }


        //filter personnel_code in ddl
        function filter_ddlPerson() {
            console.log("filter_ddlPerson");

            //$("#ddlmodalPersonnelList").select2();
            //var optionHide = $('#ddlmodalPersonnelList option[value="100008"]');
            ////optionHide.hide();
            ////optionHide.prop('disabled', true);
            //optionHide.remove();

            var table = $("#tblApproveMaster").DataTable();
            var rowDataArray = table.rows().data().toArray();

            rowDataArray.forEach(function (rowData) {
                var id_person_tbl = rowData.personnel_code;
                var optionToHide = $('#ddlmodalPersonnelList option[value="' + id_person_tbl + '"]');
                optionHide.remove();

            });
        }
    </script>
}